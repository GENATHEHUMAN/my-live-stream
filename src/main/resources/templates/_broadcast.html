<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ë°©ì†¡ ì‹œì‘</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        #localVideo {
            width: 100%;
            max-width: 1920px;
            margin-bottom: 20px;
        }
        .chat-container {
            height: 400px; 
            overflow-y: auto; 
            border: 1px solid #e0e0e0;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .chat-messages li {
            margin-bottom: 8px;
        }
        .chat-messages .message-artist {
            font-weight: bold;
            color: #007bff; /* ì•„í‹°ìŠ¤íŠ¸ ë©”ì‹œì§€ ìƒ‰ìƒ */
        }
        .chat-messages .message-mine {
            text-align: right;
        }
        .chat-messages .message-mine span {
            background-color: #dcf8c6; /* ë‚´ ë©”ì‹œì§€ ë°°ê²½ìƒ‰ */
            padding: 5px 10px;
            border-radius: 10px;
            display: inline-block;
        }
        .chat-messages .message-other span {
            background-color: #ffffff; /* ë‹¤ë¥¸ ì‚¬ëŒ ë©”ì‹œì§€ ë°°ê²½ìƒ‰ */
            padding: 5px 10px;
            border-radius: 10px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 id="broadcastTitle"></h1>
        
        <div class="row d-flex"> 
            <div class="col-md-8">
                <video id="localVideo" autoplay muted playsinline></video>
                
                <form id="broadcastForm" class="mb-4">
                    <div class="mb-3">
                        <label for="title" class="form-label">ë°©ì†¡ ì œëª©</label>
                        <input type="text" class="form-control" id="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">ë°©ì†¡ ì„¤ëª…</label>
                        <textarea class="form-control" id="description" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
				        <label for="quality" class="form-label">ë°©ì†¡ í™”ì§ˆ</label>
				        <select class="form-select" id="quality" required>
				            <option value="HD" selected>HD (1280x720)</option>
				            <option value="FHD">FHD (1920x1080)</option>
				        </select>
				    </div>
                    
                    <button type="submit" class="btn btn-primary">ë°©ì†¡ ì‹œì‘</button>
                </form>

                <div id="broadcastControls" style="display: none;">
				    <div class="alert alert-success">
				    	<p><strong>ë°©ì†¡ ì œëª©:</strong> <span id="displayBroadcastTitle"></span></p>
				        <p><strong>ë°©ì†¡ ë‚´ìš©:</strong> <span id="displayBroadcastDescription"></span></p>
				        <p>í˜„ì¬ ì‹œì²­ì ìˆ˜: <span id="viewer-count">0</span>ëª…</p>
				    </div>
				    <button type="button" id="endBroadcast" class="btn btn-danger btn-lg">ë°©ì†¡ ì¢…ë£Œ</button>
				</div>
            </div>

            <div class="col-md-4" id="chatArea" style="display: none;"> 
                <div class="card">
                    <div class="card-header">
                        ë¼ì´ë¸Œ ì±„íŒ…
                    </div>
                    <div class="card-body chat-container">
                        <ul id="chatMessages" class="list-unstyled chat-messages">
                            </ul>
                    </div>
                    <div class="card-footer">
                        <div class="input-group">
                            <input type="text" id="chatInput" class="form-control" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                            <button class="btn btn-primary" id="sendChatBtn">ì „ì†¡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    
    <script>
	 	// ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (ëª¨ë“  í•¨ìˆ˜ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥)
	    let stompClient = null;
	    let localStream = null;
	    let peerConnections = {};
	    let broadcastId = null;
	    let chatChannelNo = null; 
	    let artGroupNo = null;
	    let userId = null;
        let myNick = null; 
        
        const urlParams = new URLSearchParams(window.location.search); 

	    const configuration = {
	        iceServers: [
	            { urls: 'stun:stun.l.google.com:19302' }
	        ]
	    };
	
	    // í•¨ìˆ˜ ì •ì˜ (ì´ì œ urlParamsë¥¼ ì§ì ‘ ì‚¬ìš© ê°€ëŠ¥)
	    async function startBroadcastMedia() { 
	    	const qualitySelect = document.getElementById('quality');
	    	const selectedQuality  = qualitySelect.value;
	    	
	    	let videoConstraints = {};
	    	
	    	if (selectedQuality === 'FHD') {
	            console.log('FHD(1080p) í™”ì§ˆë¡œ ì„¤ì •í•©ë‹ˆë‹¤.');
	            videoConstraints = {
	                width: { ideal: 1920 },
	                height: { ideal: 1080 }
	            };
	        } else { 
	            console.log('HD(720p) í™”ì§ˆë¡œ ì„¤ì •í•©ë‹ˆë‹¤.');
	            videoConstraints = {
	                width: { ideal: 1280 },
	                height: { ideal: 720 }
	            };
	        }
	    	
	        try {
	            localStream = await navigator.mediaDevices.getUserMedia({
	              video: videoConstraints,
	              audio: true
	            });
	            document.getElementById('localVideo').srcObject = localStream;
	        } catch (err) {
	            console.error('Error accessing media devices:', err);
	            alert('ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
	        }
	    }
	    
	    function connect() {
	        const socket = new SockJS('/ws');
	        stompClient = Stomp.over(socket);
	        
	        stompClient.connect({}, function(frame) {
	            console.log('WebSocket ì—°ê²° ì„±ê³µ: ' + frame);
	            stompClient.subscribe('/topic/signal', function(message) {
	                const signal = JSON.parse(message.body);
	                handleSignal(signal);
	            });
	        }, function(error) {
                console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
            });
	    }
	    
	 	async function handleSignal(signal) {
	        if (signal.type === 'viewer-join') {
	            const peerConnection = createPeerConnection(signal.sender);
	            try {
	                const offer = await peerConnection.createOffer();
	                await peerConnection.setLocalDescription(offer);
	                stompClient.send("/app/signal", {}, JSON.stringify({
	                    type: 'offer', sender: broadcastId, receiver: signal.sender, data: offer
	                }));
	            } catch (error) { console.error('Offer ìƒì„± ì¤‘ ì˜¤ë¥˜:', error); }
	        } else if (signal.type === 'answer') {
	            const pc = peerConnections[signal.sender];
	            if (pc) await pc.setRemoteDescription(new RTCSessionDescription(signal.data));
	        } else if (signal.type === 'ice-candidate') {
	            const pc = peerConnections[signal.sender];
	            if (pc) await pc.addIceCandidate(new RTCIceCandidate(signal.data));
	        }
	    }
	 	
	    function createPeerConnection(viewerId) {
	        const peerConnection = new RTCPeerConnection(configuration);
	        peerConnections[viewerId] = peerConnection;
	        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
	        peerConnection.onicecandidate = event => {
	            if (event.candidate) {
	                stompClient.send("/app/signal", {}, JSON.stringify({
	                    type: 'ice-candidate', sender: broadcastId, receiver: viewerId, data: event.candidate
	                }));
	            }
	        };
	        return peerConnection;
	    }

        function displayChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const li = document.createElement('li');
            
            let senderName = message.senderNick;
            let messageClass = 'message-other'; 

            if (message.isArtist) {
                senderName = 'ğŸ‘‘ ' + senderName; 
            }

            // ë‚´ ë©”ì‹œì§€ êµ¬ë¶„
            if (myNick && message.senderNick.replace('ğŸ‘‘ ', '') === myNick.replace('ğŸ‘‘ ', '')) { 
                messageClass = 'message-mine';
            }
            
            li.className = messageClass;
            li.innerHTML = `<strong>${senderName}:</strong> <span>${message.message}</span>`;
            chatMessages.appendChild(li);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
	
	    document.addEventListener('DOMContentLoaded', function() {
	        const broadcastTitle = document.getElementById('broadcastTitle');
	        const titleInput = document.getElementById('title');
	        const descriptionInput = document.getElementById('description');
	        const qualitySelect = document.getElementById('quality');
	        const broadcastForm = document.getElementById('broadcastForm');
	        const broadcastControls = document.getElementById('broadcastControls');
            const chatArea = document.getElementById('chatArea');
	        const endBroadcastBtn = document.getElementById('endBroadcast'); 

	        const displayBroadcastTitle = document.getElementById('displayBroadcastTitle');
	        const displayBroadcastDescription = document.getElementById('displayBroadcastDescription');

            const chatInput = document.getElementById('chatInput');
            const sendChatBtn = document.getElementById('sendChatBtn');

	        artGroupNo = urlParams.get('artGroupNo'); // ì „ì—­ urlParams ì‚¬ìš©
	        userId = urlParams.get('userId');         // ì „ì—­ urlParams ì‚¬ìš©
	        const artGroupNm = urlParams.get('artGroupNm');
            myNick = decodeURIComponent(artGroupNm || 'Unknown Artist'); 

	        if (artGroupNm) {
	            broadcastTitle.textContent = `${decodeURIComponent(artGroupNm)} | ë°©ì†¡ ì‹œì‘`;
	            titleInput.value = `${decodeURIComponent(artGroupNm)}ì˜ ë¼ì´ë¸Œ ë°©ì†¡ì…ë‹ˆë‹¤!`;
	        } else {
	            broadcastTitle.textContent = 'ìƒˆë¡œìš´ ë°©ì†¡ ì‹œì‘';
	        }
	        
	        connect();
	        startBroadcastMedia(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸° ì‹œì‘

	        qualitySelect.addEventListener('change', startBroadcastMedia);

	        broadcastForm.addEventListener('submit', function (e) {
	            e.preventDefault();
	            
	            const newBroadcastId = 'broadcaster-' + Date.now();
	            const enteredTitle = titleInput.value;
                const enteredDescription = descriptionInput.value;
				
	            const broadcastData = {
	                title: enteredTitle,
	                description: enteredDescription,
	                liveQty: qualitySelect.value,
	                broadcasterId: newBroadcastId,
	                artGroupNo: artGroupNo,
	                artGroupNm: decodeURIComponent(artGroupNm), // artGroupNm ì¶”ê°€
	                userId: userId
	            };

	            broadcastId = newBroadcastId;
	            console.log('âœ… [í• ë‹¹ ì‹œì ] broadcastIdê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤:', broadcastId);

	            stompClient.send("/app/broadcast/start", {}, JSON.stringify(broadcastData));

	            // UI ë³€ê²½: í¼ ìˆ¨ê¸°ê³  ì»¨íŠ¸ë¡¤ ë° ì±„íŒ… ì˜ì—­ ë³´ì´ê¸°
	            broadcastForm.style.display = 'none';
	            broadcastControls.style.display = 'block';
                chatArea.style.display = 'block'; // ì±„íŒ… ì˜ì—­ í‘œì‹œ
	            
	            displayBroadcastTitle.textContent = enteredTitle;
	            displayBroadcastDescription.textContent = enteredDescription;
	            
	            stompClient.subscribe('/topic/viewers/' + broadcastId, function(message) {
	                const data = JSON.parse(message.body);
	                const viewerCountElement = document.getElementById('viewer-count');
	                if (viewerCountElement) {
	                    viewerCountElement.textContent = data.viewerCount;
	                }
	            });

                stompClient.subscribe('/topic/broadcast-info/' + broadcastId, function(message) {
                    const data = JSON.parse(message.body);
                    if (data.chatChannelNo) {
                        chatChannelNo = data.chatChannelNo;
                        console.log('âœ… chatChannelNoê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤:', chatChannelNo);

                        stompClient.subscribe('/topic/chat/' + chatChannelNo, function(chatMessage) {
                            displayChatMessage(JSON.parse(chatMessage.body));
                        });
                    }
                });

                sendChatBtn.addEventListener('click', sendChatMessage);
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
	        });

	        endBroadcastBtn.addEventListener('click', function () {
	            console.log('âœ… [ì‚¬ìš© ì‹œì ] ë°©ì†¡ ì¢…ë£Œ ë²„íŠ¼ í´ë¦­ë¨. í˜„ì¬ broadcastId:', broadcastId);
	            
	            Swal.fire({
	                title: "ë°©ì†¡ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", text: "ì¢…ë£Œëœ ë°©ì†¡ì€ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", icon: "warning",
	                showCancelButton: true, confirmButtonColor: "#d33", cancelButtonColor: "#3085d6",
	                confirmButtonText: "ë„¤, ì¢…ë£Œí•©ë‹ˆë‹¤.", cancelButtonText: "ì·¨ì†Œ"
	            }).then((result) => {
	                if (result.isConfirmed) {
	                    if (broadcastId) {
	                        stompClient.send("/app/broadcast/end", {}, JSON.stringify({
	                            broadcasterId: broadcastId
	                        }));
	                        for (const viewerId in peerConnections) {
	                            if (peerConnections[viewerId]) {
	                                peerConnections[viewerId].close();
	                                delete peerConnections[viewerId];
	                            }
	                        }
	                        if (localStream) {
	                            localStream.getTracks().forEach(track => track.stop());
	                        }
	                        if (stompClient && stompClient.connected) {
                                stompClient.disconnect(function() {
                                    console.log("STOMP connection disconnected.");
                                });
                            }
	                        window.close();
	                    } else {
	                        alert('ì˜¤ë¥˜: ë°©ì†¡ IDê°€ ì—†ì–´ ì¢…ë£Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
	                    }
	                }
	            });
	        });

            function sendChatMessage() {
                const messageContent = chatInput.value.trim();
                if (messageContent && stompClient && chatChannelNo) {
                    const chatMessage = {
                        chatChannelNo: chatChannelNo,
                        senderNick: myNick, 
                        message: messageContent,
                        isArtist: true 
                    };
                    stompClient.send("/app/chat/" + chatChannelNo, {}, JSON.stringify(chatMessage));
                    chatInput.value = '';
                } else if (!chatChannelNo) {
                    console.warn("ì±„íŒ… ì±„ë„ ë²ˆí˜¸ê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            }
	    });

        window.onbeforeunload = function() {
            for (const viewerId in peerConnections) {
                if (peerConnections[viewerId]) {
                    peerConnections[viewerId].close();
                }
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (stompClient && stompClient.connected) {
                stompClient.disconnect(function() {
                    console.log("STOMP connection disconnected on unload.");
                });
            }
        };
</script>
</body>
</html>